{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-md-8 offset-md-2">
    <h2 class="mb-4">Book a Parking Slot</h2>
    <form method="POST" action="{{ url_for('book_slot') }}">
      <div class="mb-3">
        <label for="lot" class="form-label">Select Lot:</label>
        <select name="lot_id" id="lot" class="form-select" required onchange="filterSpots()">
          {% for lot in lots %}
            <option value="{{ lot.id }}" data-price="{{ lot.price_per_hour }}">{{ lot.location_name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label for="spot" class="form-label">Select Spot:</label>
        <select name="spot_id" id="spot" class="form-select" required>
          {% for spot in spots %}
            <option value="{{ spot.id }}" data-lot="{{ spot.lot_id }}" {% if spot.status == 'O' %}disabled{% endif %}>
              Lot: {{ spot.lot.location_name }} | Spot #: {{ spot.spot_number }} {% if spot.status == 'O' %}- Occupied{% else %}- Available{% endif %}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="vehicle_number">Vehicle Number</label>
        <input type="text" name="vehicle_number" class="form-control" required>
      </div>

       <div class="mb-3">
        <label for="start_time" class="form-label">Start Time:</label>
        <input type="text" name="start_time" id="start_time" class="form-control" placeholder="e.g. 10:00 AM" required>
      </div>

      <div class="mb-3">
        <label for="end_time" class="form-label">End Time:</label>
        <input type="text" name="end_time" id="end_time" class="form-control" placeholder="e.g. 12:00 PM" required>
      </div>

      <p><strong>Estimated Cost: â‚¹<span id="cost">0.00</span></strong></p>

      <button type="submit" class="btn btn-primary">Book Slot</button>
    </form>
  </div>
</div>

<script>
function filterSpots() {
    const selectedLot = document.getElementById('lot').value;
    const allSpots = document.querySelectorAll('#spot option');

    allSpots.forEach(opt => {
        if (!opt.value) return;  // Skip the default
        opt.style.display = opt.dataset.lot === selectedLot ? 'block' : 'none';
    });

    document.getElementById('spot').value = ""; // reset spot
    calculateCost();  // Reset cost
}

function parseTime(timeStr) {
    const [time, modifier] = timeStr.trim().split(' ');
    if (!time || !modifier) return null;

    let [hours, minutes] = time.split(':').map(Number);
    if (modifier === 'PM' && hours !== 12) hours += 12;
    if (modifier === 'AM' && hours === 12) hours = 0;

    return new Date(0, 0, 0, hours, minutes);
}

function calculateCost() {
    const start = parseTime(document.getElementById('start_time').value);
    const end = parseTime(document.getElementById('end_time').value);
    const selectedLot = document.getElementById('lot');
    const price = parseFloat(selectedLot.options[selectedLot.selectedIndex]?.dataset.price || 0);

    if (!start || !end || end <= start) {
        document.getElementById('cost').textContent = "0.00";
        return;
    }

    const durationHours = (end - start) / (1000 * 60 * 60);
    const total = (durationHours * price).toFixed(2);
    document.getElementById('cost').textContent = total;
}

function validateBooking() {
    const start = document.getElementById('start_time').value;
    const end = document.getElementById('end_time').value;
    if (!start || !end) {
        alert("Please fill in start and end times.");
        return false;
    }
    return true;
}

document.getElementById('start_time').addEventListener('input', calculateCost);
document.getElementById('end_time').addEventListener('input', calculateCost);
</script>

{% endblock %} 



